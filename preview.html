<!DOCTYPE html>
<html>

<head>
  <script>
    // initilization of motives app page as adiin
    geotab.addin.myCustomPage1 = () => {

      return {
        initialize(api, state, callback) {
          // to get session id<token>, databaseName(like company name), userName (email)
          api.getSession(function (credentials, server) {
            api.call("Get", {
              typeName: "User",
              search: {
                name: credentials.userName
              }
            }, function (result) {
              /*
                  after geting credientials and getting user object from geotabs API post credientials to k2web to validate
                  user identity.
                  k2web calls geotabs API to validate user and generates auth_token for frontend
              */
              const apiUrl = "https://account.p.k2labs.org/log-in/geotab";
              const params = { ...credentials };

              fetch(apiUrl, {
                method: "POST",
                body: JSON.stringify(params),
                headers: {
                  "Content-type": "application/json; charset=UTF-8"
                }
              })
                .then(res => {
                  if(res.ok) { 
                    return res.json();
                  } else { 
                    throw new Error('User not authorized');
                  }
                })
                .then((data) => { 
                  /*
                      on success: we navigate user to webapp with geotab_auth_token query param
                      where at boot time we determine that the user is from geotabs iframe and we set
                      auth_token as cookie
                  */
                  const token = encodeURIComponent(data.auth_token);
                  const iframeElement = document.getElementById('motive-iframe');
                  iframeElement.width = "100%";
                  iframeElement.height = "100%";
                  iframeElement.referrerPolicy = "origin-when-cross-origin";
                  const iframeUrl = `https://app.p.k2labs.org/en-US/#/safety/overview?geotab_auth_token=${token}`;
                  iframeElement.src = iframeUrl;

                  callback();
                })
                .catch(error => { 
                  const iframeElement = document.getElementById('motive-iframe');
                  iframeElement.width = "100%";
                  iframeElement.height = "100%";
                  iframeElement.referrerPolicy = "origin-when-cross-origin";

                  iframeElement.src = `https://w2.p.k2labs.org/ett-1052/en-US/#/geotab-auth-fail`;
                  callback();
                });
            }, function (error) {
                                alert('error2 handling');

              const iframeElement = document.getElementById('motive-iframe');
              iframeElement.width = "100%";
              iframeElement.height = "100%";
              iframeElement.referrerPolicy = "origin-when-cross-origin";

              iframeElement.src = `https://w2.p.k2labs.org/ett-1052/en-US/#/geotab-auth-fail`;
              callback();
            });
          }, false);
        },
        focus(api, state) {

        },
        blur(api, state) {

        }
      };
    };
  </script>
</head>

<body>
  <iframe id="motive-iframe"></iframe>
</body>

</html>
